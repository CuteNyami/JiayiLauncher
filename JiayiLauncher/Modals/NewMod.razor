@using Microsoft.Win32
@using JiayiLauncher.Features.Mods
@using System.IO
@using System.Diagnostics
@using JiayiLauncher.Utils

<div class="select">
    <div class="select-file">
        <JiayiButton OnClick="SelectFile">Select a file</JiayiButton>
        <p>
            to begin<br>
            .dll and .exe files only
        </p>
    </div>
    
    <div class="separator">
        <div class="separator-line"></div>
        <p>or</p>
        <div class="separator-line"></div>
    </div>
    
    <div class="url" @onkeydown="Enter">
        <p>Enter the link to your mod</p>
        <JiayiTextBox Style="width: 91%" Placeholder="cool-website.com/path/to/mod.dll" @ref="_urlTextBox"/>
    </div>
</div>

@code {
    [CascadingParameter]
    public IModalService ModalService { get; set; } = default!;
    
    [CascadingParameter]
    private BlazoredModalInstance Modal { get; set; } = default!;
    
    private JiayiTextBox? _urlTextBox;
    
    private async Task SelectFile()
    {
        var dialog = new OpenFileDialog
        {
            Title = "Select a mod",
            Filter = "Injectable libraries (*.dll)|*.dll|" +
                     "External clients and injectors (*.exe)|*.exe",
            Multiselect = false
        };

        if (dialog.ShowDialog() == true)
        {
            var path = dialog.FileName;
            var name = Path.GetFileNameWithoutExtension(path);
            var mod = new Mod(name, path);
            
            var parameters = new ModalParameters()
                .Add(nameof(EditMod.Mod), mod);
            
            await Modal.CloseAsync();
            ModalService.Show<EditMod>("Edit mod", parameters);
        }
    }

    private void LinkSubmitted()
    {
        Common.SetTimeout(() => Debug.WriteLine(_urlTextBox!.Value), 5);
    }

    private void Enter(KeyboardEventArgs obj)
    {
        if (obj.Key == "Enter")
        {
            LinkSubmitted();
        }
    }

}