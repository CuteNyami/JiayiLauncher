@using JiayiLauncher.Features.Profiles
@using JiayiLauncher.Settings
@using System.IO

<div class="edit">
    <div class="edit-name" style="margin-bottom: 1em">
        <p>Give your profile a name!</p>
        <JiayiTextBox Placeholder="@Name" @ref="_textBox"/>
    </div>
    
    <JiayiButton OnClick="SaveClicked" @ref="_button"
                 Size="JiayiButton.ButtonSize.Small" Style="margin-bottom: 1em;">Save</JiayiButton>
    
    @if (JiayiSettings.Instance!.ProfileCollectionPath == string.Empty)
    {
        <br>
        <i style="color: var(--text-grayed); font-size: 14px">
            Profiles will be saved to the default location, which you can change in settings
        </i>
    }
</div>

@code {
    [Parameter]
    public string Name { get; set; } = "My profile";
    
    [CascadingParameter]
    private BlazoredModalInstance Modal { get; set; } = default!;
    
    private JiayiTextBox? _textBox;
    private JiayiButton? _button;

    private async Task SaveClicked()
    {
        // takes a bit to copy game data, so disable button
        _button!.Disabled = true;
        
        if (JiayiSettings.Instance!.ProfileCollectionPath == string.Empty)
        {
            var path = Path.Combine(
                Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData), "JiayiLauncher", "Profiles");
            
            JiayiSettings.Instance.ProfileCollectionPath = path;
            ProfileCollection.Create(path);
            JiayiSettings.Instance.Save();
        }
        
        var name = _textBox?.Value is null or "" ? Name : _textBox.Value;
        var profile = Profile.Create(name, ProfileCollection.Current!);
        ProfileCollection.Current!.Add(profile);
        
        await Modal.CloseAsync(ModalResult.Ok(profile));
    }
}